---
# ÉTAPE 1 : Installation et Configuration du Site sur TOUS les noeuds
- name: Installation du Service Web
  hosts: node01, node02
  become: yes
  tasks:
    - name: Installation de Apache (httpd) et wget
      dnf:
        name: 
          - httpd
          - wget
        state: present

    # Le correctif du Pare-feu (déjà appliqué, mais on le garde)
    - name: Autoriser le trafic HTTP dans le pare-feu
      firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes
      ignore_errors: yes

    - name: Activation de server-status pour le monitoring
      copy:
        dest: /etc/httpd/conf.d/status.conf
        content: |
          <Location /server-status>
              SetHandler server-status
              Require local
          </Location>

    - name: Déploiement de la page Web personnalisée
      copy:
        dest: /var/www/html/index.html
        mode: '0644'
        content: |
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <title>HA Cluster Demo</title>
              <style>
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                  .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; border-top: 8px solid #3498db; }
                  h1 { color: #2c3e50; margin-bottom: 10px; }
                  p { color: #7f8c8d; font-size: 1.1em; }
                  .server-name { font-size: 2em; font-weight: bold; color: #e74c3c; margin: 20px 0; display: block; }
                  .status { display: inline-block; padding: 5px 15px; background: #2ecc71; color: white; border-radius: 20px; font-size: 0.9em; }
                  .footer { margin-top: 30px; font-size: 0.8em; color: #bdc3c7; }
              </style>
          </head>
          <body>
              <div class="card">
                  <h1>Cluster Haute Dispo</h1>
                  <p>Cette page est servie par :</p>
                  <span class="server-name">{{ ansible_hostname | upper }}</span>
                  <br>
                  <span class="status">● Système Actif</span>
                  <div class="footer">Propulsé par Rocky Linux & Pacemaker</div>
              </div>
          </body>
          </html>

    - name: Désactivation du démarrage automatique système
      service:
        name: httpd
        enabled: no
        state: stopped

# ÉTAPE 2 : Configuration du Cluster (Piloté depuis node01)
- name: Ajout de la ressource Web au Cluster
  hosts: node01
  become: yes
  tasks:
    - name: Création de la ressource Apache dans Pacemaker
      shell: >
        pcs resource create WebService ocf:heartbeat:apache 
        configfile=/etc/httpd/conf/httpd.conf 
        statusurl="http://localhost/server-status" 
        op monitor interval=30s
      register: result
      # On ignore l'erreur si la ressource existe déjà
      failed_when: "result.rc != 0 and 'already exists' not in result.stderr"

    - name: Création du groupe de ressources
      shell: pcs resource group add HA_Group Cluster_VIP WebService
      register: group_result
      # --- CORRECTION ICI ---
      # On ignore l'erreur si le groupe contient déjà les ressources
      failed_when: >
        group_result.rc != 0 and 
        'exists' not in group_result.stderr and 
        'already present' not in group_result.stderr

    - name: Nettoyage des erreurs (Cleanup)
      shell: pcs resource cleanup