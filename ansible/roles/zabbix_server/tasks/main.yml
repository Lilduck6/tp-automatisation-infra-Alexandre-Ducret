---
- name: Install dependencies
  ansible.builtin.apt:
    name:
      - wget
      - gnupg
      - lsb-release
      - ca-certificates
    state: present
    update_cache: true

# Zabbix 6.0 LTS sur Ubuntu 22.04 (jammy)
- name: Install Zabbix repo package
  ansible.builtin.apt:
    deb: https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-6+ubuntu22.04_all.deb

- name: apt update after zabbix repo
  ansible.builtin.apt:
    update_cache: true

- name: Install Zabbix server + frontend + agent + DB (MariaDB)
  ansible.builtin.apt:
    name:
      - mariadb-server
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-sql-scripts
      - zabbix-agent
    state: present

- name: Ensure MariaDB started
  ansible.builtin.systemd:
    name: mariadb
    enabled: true
    state: started

- name: Create Zabbix database
  ansible.builtin.shell: |
    mysql -e "CREATE DATABASE IF NOT EXISTS zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
    mysql -e "CREATE USER IF NOT EXISTS 'zabbix'@'localhost' IDENTIFIED BY 'zabbixpass';"
    mysql -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"
  args:
    executable: /bin/bash
  changed_when: false

- name: Import initial schema (only if empty)
  ansible.builtin.shell: |
    test "$(mysql -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='zabbix';")" -gt 0 \
    || zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql -uzabbix -pzabbixpass zabbix
  args:
    executable: /bin/bash
  changed_when: false

- name: Configure Zabbix server DB password
  ansible.builtin.lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: '^DBPassword='
    line: 'DBPassword=zabbixpass'

- name: Start and enable Zabbix services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: restarted
  loop:
    - zabbix-server
    - apache2
    - zabbix-agent
